{% extends "base.html" %}

{% block content %}
    <h1>Faktura nr {{ faktura.numer }}</h1>

    <p>
        <a href="{% url 'edytuj_fakture' pk=faktura.pk %}" class="btn btn-primary">Edytuj fakturę</a>
        <a href="{% url 'panel_uzytkownika' %}" class="btn btn-secondary">Powrót</a>
        <a href="{% url 'generuj_pdf' pk=faktura.pk %}" class="btn btn-outline-secondary">Pobierz PDF</a>
        <a href="{% url 'wyslij_fakture' pk=faktura.pk %}" class="btn btn-success">Wyślij mailem</a>
    </p>
    <a href="{% url 'stworz_korekte' faktura.pk %}">Stwórz korektę</a>
    {% if faktura.sposob_platnosci == 'gotowka' and faktura.status == 'oplacona' %}
    <a href="{% url 'generate_kp' faktura.pk %}" class="btn btn-warning">Wygeneruj KP</a>
{% endif %}

{% if faktura.kp %}
    <div class="mt-3">
        <strong>Powiązane KP:</strong>
        <a href="{% url 'szczegoly_faktury' faktura.kp.pk %}">{{ faktura.kp.numer }}</a>
    </div>
{% endif %}

    <h2>Dane Faktury</h2>
    <dl>
        <dt>Typ dokumentu:</dt>
        <dd>{{ faktura.get_typ_dokumentu_display }}</dd>
        <dt>Typ faktury:</dt>
        <dd>{{ faktura.get_typ_faktury_display }}</dd>
        <dt>Data wystawienia:</dt>
        <dd>{{ faktura.data_wystawienia|date:"Y-m-d" }}</dd>
        <dt>Data sprzedaży:</dt>
        <dd>{{ faktura.data_sprzedazy|date:"Y-m-d" }}</dd>
        <dt>Miejsce wystawienia:</dt>
        <dd>{{ faktura.miejsce_wystawienia }}</dd>
        <dt>Sposób płatności:</dt>
        <dd>{{ faktura.get_sposob_platnosci_display }}</dd>
        <dt>Termin płatności:</dt>
        <dd>{{ faktura.termin_platnosci|date:"Y-m-d" }}</dd>
        <dt>Status:</dt>
        <dd>{{ faktura.get_status_display }}</dd>
       <dt>Waluta:</dt>
       <dd>{{ faktura.waluta }}</dd>
      {% if faktura.zwolnienie_z_vat %}
        <dt>Zwolnienie z VAT:</dt>
         <dd>{{ faktura.get_powod_zwolnienia_display }}</dd>
      {% endif %}
      {% if faktura.uwagi %}
        <dt>Uwagi:</dt>
        <dd>{{ faktura.uwagi }}</dd>
      {% endif %}

    </dl>
    <h2>Sprzedawca</h2>
        <p><strong>{{ faktura.sprzedawca.nazwa }}</strong></p>
        <p>NIP: {{ faktura.sprzedawca.nip }}</p>
        <p>{{ faktura.sprzedawca.ulica }} {{ faktura.sprzedawca.numer_domu }}{% if faktura.sprzedawca.numer_mieszkania %}/{{ faktura.sprzedawca.numer_mieszkania }}{% endif %}</p>
        <p>{{ faktura.sprzedawca.kod_pocztowy }} {{ faktura.sprzedawca.miejscowosc }}</p>
        <p>{{ faktura.sprzedawca.kraj}}</p>

    <h2>Nabywca</h2>
    <p><strong>{{ faktura.nabywca.nazwa }}</strong></p>
    <p>NIP: {{ faktura.nabywca.nip }}</p>
    <p>{{ faktura.nabywca.ulica }} {{ faktura.nabywca.numer_domu }}{% if faktura.nabywca.numer_mieszkania %}/{{ faktura.nabywca.numer_mieszkania }}{% endif %}</p>
    <p>{{ faktura.nabywca.kod_pocztowy }} {{ faktura.nabywca.miejscowosc }}</p>
     <p>{{ faktura.nabywca.kraj }}</p>
    <h2>Pozycje Faktury</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Nazwa</th>
                 <th class="rabat-col">Rabat</th>
                <th class="rabat-col">Typ rabatu</th>
                <th>Ilość</th>
                <th>Jednostka</th>
                <th class="cena-col">Cena netto</th>
                <th class="vat-col">VAT</th>
                <th class="wartosc-netto-col">Wartość netto</th>
                <th class="wartosc-brutto-col">Wartość brutto</th>
            </tr>
        </thead>
        <thead>
            <tr>
                <th>Suma netto</th>
                <th>Suma VAT</th>
                <th>Suma brutto</th>
            </tr>
        </thead>
        <tbody>
            {% for pozycja in faktura.pozycjafaktury_set.all %}
    <tr>
        <td>{{ pozycja.nazwa }}</td>
        <td class="rabat-col">{{ pozycja.rabat|default:"-" }}</td>
        <td class="rabat-col">{{ pozycja.rabat_typ|default:"-" }}</td>
        <td>{{ pozycja.ilosc|floatformat:2 }}</td>
        <td>{{ pozycja.jednostka }}</td>
        <td>{{ pozycja.cena_netto|floatformat:2 }}</td>
        <td>{{ pozycja.vat }}</td>
        <td class="wartosc-netto-col">{{ pozycja.wartosc_netto|floatformat:2 }}</td>
        <td class="wartosc-brutto-col">{{ pozycja.wartosc_brutto|floatformat:2 }}</td>
    </tr>
        {% endfor %}
        </tbody>
         <tfoot>
            <tr class="suma-przed-rabatem">
                <td colspan="7" class="text-end">Suma netto przed rabatem:</td>
                <td class="suma-netto-przed-rabatem">{{faktura.suma_netto|floatformat:2}}</td>
            </tr>
            <tr class="suma-rabat" >
                <td colspan="7" class="text-end">Suma rabatu:</td>
                <td class="suma-rabatu"></td>
             </tr>
            <tr class="suma-po-rabacie">
                <td colspan="7" class="text-end">Suma netto po rabacie:</td>
                <td class="suma-netto-po-rabacie">{{faktura.suma_netto|floatformat:2}}</td>

            </tr>
             <tr class="vat-row">
                <td colspan="7" class="text-end">Suma VAT:</td>
                <td class="suma-vat">{{ faktura.suma_vat|floatformat:2 }}</td>
            </tr>
            <tr>
                <td colspan="7"  class="text-end">Suma brutto:</td>
                <td class="suma-brutto">{{ faktura.suma_brutto|floatformat:2 }}</td>
                <td>{{ pozycja.wartosc_netto|floatformat:2 }}</td>
                <td>{{ pozycja.wartosc_brutto|floatformat:2 }}</td>
            </tr>


        </tfoot>
    </table>

     <p><strong>Wystawca:</strong> {{ faktura.wystawca|default:"Brak danych" }}</p>  
    {% if faktura.odbiorca %}
        <p><strong>Odbiorca:</strong> {{ faktura.odbiorca }}</p>
    {% endif %}

    {% if faktura.uwagi %}
        <p><strong>Uwagi:</strong> {{ faktura.uwagi }}</p>
    {% endif %}
    {% if not faktura.faktura_cykliczna %}
<a href="{% url 'zarzadzaj_cyklem' faktura.pk %}" class="btn btn-info">
    Ustaw cykl generowania
</a>
{% else %}
<div class="alert alert-info">
    <h5>Cykl generowania:</h5>
    <p>Typ: {{ faktura.faktura_cykliczna.get_cykl_display }}</p>
    <p>Następna generacja: {{ faktura.faktura_cykliczna.nastepna_generacja }}</p>
    <a href="{% url 'dezaktywuj_cykl' faktura.pk %}" class="btn btn-warning">
        Zatrzymaj cykl
    </a>
</div>
{% endif %}
{% endblock %}